name: Inputs, Reusable Job, Cache & Container Demo
on:
  workflow_dispatch:
    inputs:
      project:
        description: "Project to run"
        required: true
        type: choice
        options:
          - "chromium-prod"
          - "firefox-prod"
      grep:
        description: "Grep filter for tests"
        required: true
        default: "@fullScope"
        type: choice
        options:
          - "@fullScope"
          - "@regression"
          - "@smoke"
      workers:
        description: "Number of concurrent workers"
        required: true
        default: "5"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
      excel_report:
        description: "Upload Excel report"
        required: true
        default: false
        type: boolean
jobs:
  static-code-analysis:
    uses: ./.github/workflows/static-code-analysis.yml
  npm-script-execution:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.54.0-noble
    needs: static-code-analysis
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22.16.0"

      - name: Cache node modules
        id: cache-node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-node_modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Project execution
        env:
          GREP: ${{ github.event.inputs.grep }}
          HEADLESS: "true"
          WORKERS: ${{ github.event.inputs.workers }}
          EXCEL_REPORTER_ENABLED: ${{ github.event.inputs.excel_report }}
          EXCEL_REPORTER_MANDATORY: ${{ github.event.inputs.excel_report }}
          HOME: "/root" # Necessary for the firefox browser to work correctly
        run: npm run ${{ github.event.inputs.project }}

      - name: Upload Excel report
        if: ${{ !cancelled() && github.event.inputs.excel_report == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: PlaywrightDemo_TS
          path: excel-report/PlaywrightDemo_TS.xlsx
          retention-days: 7
